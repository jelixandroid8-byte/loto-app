{% extends 'layout.html' %}

{% block title %}Nueva Venta{% endblock %}

{% block content %}
<div class="form-container" style="max-width: 800px;">
    <h2>Registrar Nueva Venta</h2>
    <form method="post" id="sale-form">
        <div class="form-group">
            <label for="raffle_id">Sorteo</label>
            <select id="raffle_id" name="raffle_id" required>
                {% for raffle in raffles %}
                    <option value="{{ raffle['id'] }}">
                        Sorteo del {{ raffle['raffle_date'].strftime('%Y-%m-%d') }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="client_id">Cliente</label>
            <select id="client_id" name="client_id" required>
                {% for client in clients %}
                    <option value="{{ client['id'] }}">
                        {{ client['name'] }} {{ client['last_name'] }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <h4>Ítems de la Venta</h4>
        
        <div id="invoice-items-container">
            <div class="item-header">
                <div class="item-number-wrapper">Número</div>
                <div class="item-quantity">Cantidad</div>
                <div class="item-subtotal">Subtotal</div>
                <div class="item-action">Acción</div>
            </div>
            <!-- Dynamic items will be inserted here -->
        </div>
        
        <button type="button" id="add-item-btn" class="btn btn-secondary">+ Añadir Ítem</button>

        <hr>
        <h3 id="total-display">Total de la Venta: $0.00</h3>

        <div class="form-actions">
            <button type="submit" class="btn">Guardar Venta</button>
            <a href="{{ url_for('seller_dashboard') }}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('sale-form');
    const container = document.getElementById('invoice-items-container');
    const addItemBtn = document.getElementById('add-item-btn');
    const totalDisplay = document.getElementById('total-display');

    function updateTotal() {
        let total = 0;
        container.querySelectorAll('.item-row').forEach(row => {
            const subtotalSpan = row.querySelector('.item-subtotal span');
            if (subtotalSpan) {
                total += parseFloat(subtotalSpan.textContent.replace('$', ''));
            }
        });
        totalDisplay.textContent = `Total de la Venta: $${total.toFixed(2)}`;
    }

    function calculateSubtotal(row) {
        const numberInput = row.querySelector('input[name="number"]');
        const quantityInput = row.querySelector('input[name="quantity"]');
        const subtotalSpan = row.querySelector('.item-subtotal span');

        const number = numberInput.value;
        const quantity = parseInt(quantityInput.value, 10) || 0;
        let price = 0;

        if (number.length === 4) {
            price = 1.00;
        } else if (number.length === 2) {
            price = 0.25;
        }
        
        const subtotal = price * quantity;
        subtotalSpan.textContent = `$${subtotal.toFixed(2)}`;
        updateTotal();
    }

    function handleNumberInput(event) {
        const currentInput = event.target;
        const currentRow = currentInput.closest('.item-row');
        const errorDiv = currentRow.querySelector('.item-error');
        errorDiv.textContent = ''; // Clear previous errors

        const number = currentInput.value;
        if (number.length > 0 && ![2, 4].includes(number.length)) {
            errorDiv.textContent = 'El número debe tener 2 o 4 cifras.';
            return;
        }

        // Duplicate check
        const allNumberInputs = container.querySelectorAll('input[name="number"]');
        let duplicateFound = false;
        allNumberInputs.forEach(input => {
            if (duplicateFound || input === currentInput) return;

            if (input.value === number && number.length > 0) {
                const targetRow = input.closest('.item-row');
                const targetQuantityInput = targetRow.querySelector('input[name="quantity"]');
                const currentQuantityInput = currentRow.querySelector('input[name="quantity"]');
                
                const currentQuantity = parseInt(currentQuantityInput.value, 10) || 1;
                const targetQuantity = parseInt(targetQuantityInput.value, 10) || 0;

                targetQuantityInput.value = targetQuantity + currentQuantity;
                
                const originalColor = targetRow.style.backgroundColor;
                targetRow.style.backgroundColor = '#e8f5e9';
                setTimeout(() => {
                    targetRow.style.backgroundColor = originalColor;
                }, 1000);

                currentRow.remove();
                calculateSubtotal(targetRow);
                duplicateFound = true;
            }
        });
        
        if (!duplicateFound) {
            calculateSubtotal(currentRow);
        }
    }

    function addNewItem() {
        const itemRow = document.createElement('div');
        itemRow.classList.add('item-row');
        itemRow.innerHTML = `
            <div class="item-number-wrapper">
                <input type="text" inputmode="numeric" pattern="[0-9]*" name="number" class="item-number" placeholder="Número (2 o 4 cifras)" required>
                <div class="item-error"></div>
            </div>
            <input type="number" inputmode="numeric" name="quantity" class="item-quantity" placeholder="Cantidad" min="1" step="1" required>
            <div class="item-subtotal"><span>$0.00</span></div>
            <button type="button" class="btn btn-danger btn-sm delete-item-btn">Borrar</button>
        `;
        container.appendChild(itemRow);
        calculateSubtotal(itemRow);
        // Focus on the new item's number input for rapid entry
        const newNumberInput = itemRow.querySelector('input[name="number"]');
        if (newNumberInput) {
            newNumberInput.focus();
        }
    }

    // --- Event Delegation ---
    container.addEventListener('focusout', function(event) {
        if (event.target && event.target.matches('input[name="number"]')) {
            handleNumberInput(event);
        }
    });

    container.addEventListener('input', function(event) {
        if (event.target && event.target.matches('input[name="quantity"]')) {
            calculateSubtotal(event.target.closest('.item-row'));
        }
        if (event.target && event.target.matches('input[name="number"]')) {
            const errorDiv = event.target.closest('.item-row').querySelector('.item-error');
            if (errorDiv) errorDiv.textContent = '';
        }
    });

    container.addEventListener('click', function(event) {
        if (event.target && event.target.matches('.delete-item-btn')) {
            event.target.closest('.item-row').remove();
            updateTotal();
        }
    });

    // --- Enter Key Navigation ---
    form.addEventListener('keydown', function(event) {
        if (event.key !== 'Enter') return;

        const target = event.target;

        // Prevent form submission on Enter unless it's a submit button
        if (target.type !== 'submit') {
            event.preventDefault();
        }

        if (target.matches('input[name="number"]')) {
            const itemRow = target.closest('.item-row');
            const quantityInput = itemRow.querySelector('input[name="quantity"]');
            if (quantityInput) {
                quantityInput.focus();
            }
        } else if (target.matches('input[name="quantity"]')) {
            // Check if the current item is valid before adding a new one
            const itemRow = target.closest('.item-row');
            const numberInput = itemRow.querySelector('input[name="number"]');
            if (numberInput.value.trim() !== '' && target.value.trim() !== '') {
                addNewItem(); // This will create a new row and focus it
            }
        }
    });

    // Add one item to start with
    addNewItem();
    // Clear the initial item for a clean start, but keep focus
    const firstInput = container.querySelector('input[name="number"]');
    if(firstInput) {
        firstInput.value = '';
        calculateSubtotal(firstInput.closest('.item-row'));
    }

    // Add new item when button is clicked
    addItemBtn.addEventListener('click', addNewItem);

    // Final validation before submit
    form.addEventListener('submit', function(e) {
        let hasInvalid = false;
        let itemCount = 0;
        container.querySelectorAll('.item-row').forEach(row => {
            itemCount++;
            const numberInput = row.querySelector('input[name="number"]');
            const errorDiv = row.querySelector('.item-error');
            if (numberInput.value.length > 0 && ![2, 4].includes(numberInput.value.length)) {
                errorDiv.textContent = 'El número debe tener 2 o 4 cifras.';
                hasInvalid = true;
            }
        });

        if (itemCount === 0) {
            alert('Debe agregar al menos un ítem a la venta.');
            hasInvalid = true;
        }

        if (hasInvalid) {
            e.preventDefault();
            alert('Por favor, corrija los errores en los ítems antes de guardar.');
        }
    });
});
</script>

<style>
    .form-container {
        margin: 0 auto; /* Center the form horizontally */
        padding: 20px; /* Add padding around the form */
        border: 1px solid #ddd; /* Add a light border */
        border-radius: 8px; /* Round the corners */
        background-color: #f9f9f9; /* Light background for better contrast */
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Add a subtle shadow */
    }

    .form-container h2 {
        text-align: center; /* Center the heading */
        margin-bottom: 20px; /* Add space below the heading */
    }

    .form-group label {
        display: block; /* Ensure labels are on their own line */
        margin-bottom: 5px; /* Add space below labels */
        font-weight: bold; /* Make labels stand out */
    }

    .form-group select, .form-group input {
        width: 100%; /* Make inputs and selects take full width */
        padding: 10px; /* Add padding inside inputs */
        margin-bottom: 15px; /* Add space below inputs */
        border: 1px solid #ccc; /* Light border for inputs */
        border-radius: 4px; /* Round the corners */
        box-sizing: border-box; /* Include padding and border in width */
    }

    .form-actions {
        display: flex;
        justify-content: space-between; /* Space out the buttons */
        align-items: center; /* Align buttons vertically */
    }

    .form-actions .btn {
        padding: 10px 20px; /* Add padding to buttons */
        border: none; /* Remove default border */
        border-radius: 4px; /* Round the corners */
        cursor: pointer; /* Change cursor to pointer */
    }

    .form-actions .btn-secondary {
        background-color: #f0f0f0; /* Light gray background */
        color: #333; /* Dark text color */
    }

    .form-actions .btn-secondary:hover {
        background-color: #e0e0e0; /* Darker gray on hover */
    }

    .form-actions .btn {
        background-color: #007bff; /* Primary blue color */
        color: #fff; /* White text */
    }

    .form-actions .btn:hover {
        background-color: #0056b3; /* Darker blue on hover */
    }

    .item-header, .item-row {
        display: flex;
        align-items: center; /* Align items vertically */
        justify-content: space-between; /* Distribute space evenly */
        margin-bottom: 10px;
        gap: 10px;
    }

    .item-header > div, .item-row > div {
        text-align: center; /* Center align text */
    }

    .item-number-wrapper {
        flex: 2; /* Adjust width proportion */
        min-width: 100px; /* Ensure minimum width */
    }

    .item-number {
        width: 100%; /* Ensure input takes full width */
        box-sizing: border-box; /* Include padding and border in width */
    }

    .item-quantity {
        flex: 0.5; /* Reduce the width proportion */
        min-width: 50px; /* Ensure a smaller minimum width */
    }

    .item-subtotal {
        flex: 1.5; /* Adjust width proportion */
        min-width: 100px; /* Ensure minimum width */
        font-weight: bold;
    }

    .item-action {
        flex: 1; /* Ensure enough space for the button */
        min-width: 80px; /* Ensure the button stays on the same line */
        text-align: center; /* Center align the button */
    }

    .btn-sm {
        padding: 5px 10px;
        font-size: 0.8rem;
    }

    /* Media query for smaller screens */
    @media (max-width: 600px) {
        .form-container {
            padding: 10px; /* Reduce padding */
        }

        .form-container h2, .form-container h3, .form-container h4 {
            font-size: 1rem; /* Smaller font size for titles */
            margin-bottom: 5px; /* Reduce space below titles */
        }

        .form-group label {
            font-size: 0.9rem; /* Smaller font size for labels */
            margin-bottom: 3px; /* Reduce space below labels */
        }

        .form-group select, .form-group input {
            padding: 5px; /* Reduce padding inside inputs */
            font-size: 0.9rem; /* Smaller font size for inputs */
            margin-bottom: 10px; /* Reduce space below inputs */
        }

        .item-header, .item-row {
            gap: 5px; /* Reduce gap between columns */
        }

        .item-number-wrapper, .item-quantity, .item-subtotal, .item-action {
            flex: 1; /* Adjust proportions for smaller screens */
            min-width: auto; /* Remove strict minimum width */
        }

        .item-quantity {
            flex: 0.5; /* Keep the shorter width for cantidad */
        }

        .item-number, .item-quantity {
            padding: 5px; /* Reduce padding inside fields */
            font-size: 0.9rem; /* Smaller font size */
        }

        .item-subtotal {
            font-size: 0.9rem; /* Smaller font size */
        }

        .btn-sm {
            padding: 3px 8px; /* Smaller buttons */
            font-size: 0.8rem; /* Smaller font size for buttons */
        }

        .form-actions {
            flex-direction: column; /* Stack buttons vertically */
            gap: 5px; /* Reduce gap between buttons */
        }

        .form-actions .btn {
            padding: 8px 15px; /* Reduce padding for buttons */
            font-size: 0.9rem; /* Smaller font size */
        }
    }
</style>
{% endblock %}