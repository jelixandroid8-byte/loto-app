{% extends 'layout.html' %}

{% block title %}Nueva Venta{% endblock %}

{% block content %}
<div class="form-container" style="max-width: 800px;">
    <h2>Registrar Nueva Venta</h2>
    <form method="post" id="sale-form">
        <div class="form-group">
            <label for="raffle_id">Sorteo</label>
            <select id="raffle_id" name="raffle_id" required>
                {% for raffle in raffles %}
                    <option value="{{ raffle['id'] }}">
                        Sorteo del {{ raffle['raffle_date'].strftime('%Y-%m-%d') }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="client_id">Cliente</label>
            <select id="client_id" name="client_id" required>
                {% for client in clients %}
                    <option value="{{ client['id'] }}">
                        {{ client['name'] }} {{ client['last_name'] }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <hr>
        <h4>Ítems de la Venta</h4>
        <p>Ingrese números de 4 cifras para billetes ($1.00) o 2 cifras para chances ($0.25).</p>
        
        <div id="invoice-items-container">
            <div class="item-header">
                <div class="item-number-wrapper">Número</div>
                <div class="item-quantity">Cantidad</div>
                <div class="item-subtotal">Subtotal</div>
                <div class="item-action">Acción</div>
            </div>
            <!-- Dynamic items will be inserted here -->
        </div>
        
        <button type="button" id="add-item-btn" class="btn btn-secondary">+ Añadir Ítem</button>

        <hr>
        <h3 id="total-display">Total de la Venta: $0.00</h3>

        <div class="form-actions">
            <button type="submit" class="btn">Guardar Venta</button>
            <a href="{{ url_for('seller_dashboard') }}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('sale-form');
    const container = document.getElementById('invoice-items-container');
    const addItemBtn = document.getElementById('add-item-btn');
    const totalDisplay = document.getElementById('total-display');

    function updateTotal() {
        let total = 0;
        container.querySelectorAll('.item-row').forEach(row => {
            const subtotalSpan = row.querySelector('.item-subtotal span');
            if (subtotalSpan) {
                total += parseFloat(subtotalSpan.textContent.replace('

<style>
    .item-header, .item-row {
        display: flex;
        align-items: flex-start; /* Align to top for error message */
        margin-bottom: 10px;
        gap: 10px;
    }
    .item-header > div { padding-bottom: 1em; } /* Match space of error div */
    .item-number-wrapper { flex: 3; }
    .item-number { width: 100%; }
    .item-error {
        color: #dc3545; /* Bootstrap danger color */
        font-size: 0.875em;
        height: 1em; /* Reserve space to prevent layout shift */
    }
    .item-quantity { flex: 2; }
    .item-subtotal { flex: 2; font-weight: bold; padding-top: 8px; } /* Add padding to align with inputs */
    .item-action { flex: 1; padding-top: 8px; }
    .btn-sm { padding: 5px 10px; font-size: 0.8rem; }
</style>
{% endblock %}, ''));
            }
        });
        totalDisplay.textContent = `Total de la Venta: ${total.toFixed(2)}`;
    }

    function calculateSubtotal(row) {
        const numberInput = row.querySelector('input[name="number"]');
        const quantityInput = row.querySelector('input[name="quantity"]');
        const subtotalSpan = row.querySelector('.item-subtotal span');

        const number = numberInput.value;
        const quantity = parseInt(quantityInput.value, 10) || 0;
        let price = 0;

        if (number.length === 4) {
            price = 1.00;
        } else if (number.length === 2) {
            price = 0.25;
        }
        
        const subtotal = price * quantity;
        subtotalSpan.textContent = `${subtotal.toFixed(2)}`;
        updateTotal();
    }

    function handleNumberInput(event) {
        const currentInput = event.target;
        const currentRow = currentInput.closest('.item-row');
        const errorDiv = currentRow.querySelector('.item-error');
        errorDiv.textContent = ''; // Clear previous errors

        const number = currentInput.value;
        if (number.length > 0 && ![2, 4].includes(number.length)) {
            errorDiv.textContent = 'El número debe tener 2 o 4 cifras.';
            return;
        }

        // Duplicate check
        const allNumberInputs = container.querySelectorAll('input[name="number"]');
        let duplicateFound = false;
        allNumberInputs.forEach(input => {
            if (duplicateFound || input === currentInput) return;

            if (input.value === number && number.length > 0) {
                const targetRow = input.closest('.item-row');
                const targetQuantityInput = targetRow.querySelector('input[name="quantity"]');
                const currentQuantityInput = currentRow.querySelector('input[name="quantity"]');
                
                const currentQuantity = parseInt(currentQuantityInput.value, 10) || 1;
                const targetQuantity = parseInt(targetQuantityInput.value, 10) || 0;

                targetQuantityInput.value = targetQuantity + currentQuantity;
                
                const originalColor = targetRow.style.backgroundColor;
                targetRow.style.backgroundColor = '#e8f5e9';
                setTimeout(() => {
                    targetRow.style.backgroundColor = originalColor;
                }, 1000);

                currentRow.remove();
                calculateSubtotal(targetRow);
                duplicateFound = true;
            }
        });
        
        if (!duplicateFound) {
            calculateSubtotal(currentRow);
        }
    }

    function addNewItem() {
        const itemRow = document.createElement('div');
        itemRow.classList.add('item-row');
        itemRow.innerHTML = `
            <div class="item-number-wrapper">
                <input type="text" inputmode="numeric" pattern="[0-9]*" name="number" class="item-number" placeholder="Número (2 o 4 cifras)" required>
                <div class="item-error"></div>
            </div>
            <input type="number" inputmode="numeric" name="quantity" class="item-quantity" placeholder="Cantidad" min="1" step="1" required>
            <div class="item-subtotal"><span>$0.00</span></div>
            <button type="button" class="btn btn-danger btn-sm delete-item-btn">Borrar</button>
        `;
        container.appendChild(itemRow);
        calculateSubtotal(itemRow);
        // Focus on the new item's number input for rapid entry
        const newNumberInput = itemRow.querySelector('input[name="number"]');
        if (newNumberInput) {
            newNumberInput.focus();
        }
    }

    // --- Event Delegation ---
    container.addEventListener('focusout', function(event) {
        if (event.target && event.target.matches('input[name="number"]')) {
            handleNumberInput(event);
        }
    });

    container.addEventListener('input', function(event) {
        if (event.target && event.target.matches('input[name="quantity"]')) {
            calculateSubtotal(event.target.closest('.item-row'));
        }
        if (event.target && event.target.matches('input[name="number"]')) {
            const errorDiv = event.target.closest('.item-row').querySelector('.item-error');
            if (errorDiv) errorDiv.textContent = '';
        }
    });

    container.addEventListener('click', function(event) {
        if (event.target && event.target.matches('.delete-item-btn')) {
            event.target.closest('.item-row').remove();
            updateTotal();
        }
    });

    // --- Enter Key Navigation ---
    form.addEventListener('keydown', function(event) {
        if (event.key !== 'Enter') return;

        const target = event.target;

        // Prevent form submission on Enter unless it's a submit button
        if (target.type !== 'submit') {
            event.preventDefault();
        }

        if (target.matches('input[name="number"]')) {
            const itemRow = target.closest('.item-row');
            const quantityInput = itemRow.querySelector('input[name="quantity"]');
            if (quantityInput) {
                quantityInput.focus();
            }
        } else if (target.matches('input[name="quantity"]')) {
            // Check if the current item is valid before adding a new one
            const itemRow = target.closest('.item-row');
            const numberInput = itemRow.querySelector('input[name="number"]');
            if (numberInput.value.trim() !== '' && target.value.trim() !== '') {
                addNewItem(); // This will create a new row and focus it
            }
        }
    });

    // Add one item to start with
    addNewItem();
    // Clear the initial item for a clean start, but keep focus
    const firstInput = container.querySelector('input[name="number"]');
    if(firstInput) {
        firstInput.value = '';
        calculateSubtotal(firstInput.closest('.item-row'));
    }

    // Add new item when button is clicked
    addItemBtn.addEventListener('click', addNewItem);

    // Final validation before submit
    form.addEventListener('submit', function(e) {
        let hasInvalid = false;
        let itemCount = 0;
        container.querySelectorAll('.item-row').forEach(row => {
            itemCount++;
            const numberInput = row.querySelector('input[name="number"]');
            const errorDiv = row.querySelector('.item-error');
            if (numberInput.value.length > 0 && ![2, 4].includes(numberInput.value.length)) {
                errorDiv.textContent = 'El número debe tener 2 o 4 cifras.';
                hasInvalid = true;
            }
        });

        if (itemCount === 0) {
            alert('Debe agregar al menos un ítem a la venta.');
            hasInvalid = true;
        }

        if (hasInvalid) {
            e.preventDefault();
            alert('Por favor, corrija los errores en los ítems antes de guardar.');
        }
    });
});
</script>

<style>
    .item-header, .item-row {
        display: flex;
        align-items: flex-start; /* Align to top for error message */
        margin-bottom: 10px;
        gap: 10px;
    }
    .item-header > div { padding-bottom: 1em; } /* Match space of error div */
    .item-number-wrapper { flex: 3; }
    .item-number { width: 100%; }
    .item-error {
        color: #dc3545; /* Bootstrap danger color */
        font-size: 0.875em;
        height: 1em; /* Reserve space to prevent layout shift */
    }
    .item-quantity { flex: 2; }
    .item-subtotal { flex: 2; font-weight: bold; padding-top: 8px; } /* Add padding to align with inputs */
    .item-action { flex: 1; padding-top: 8px; }
    .btn-sm { padding: 5px 10px; font-size: 0.8rem; }
</style>
{% endblock %}