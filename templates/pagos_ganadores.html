{% extends 'layout.html' %}

{% block title %}Pagos a Ganadores{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Pagos a Ganadores</h1>
    <div class="page-actions">
        <a href="{{ url_for('seller_dashboard') }}" class="btn">Volver al Dashboard</a>
    </div>
</div>

<div class="filters">
    <label for="sorteo">Seleccionar Sorteo:</label>
    <select id="sorteo" name="sorteo">
        <!-- Options will be dynamically populated -->
    </select>
    <button type="button" class="btn" id="refresh-btn">Cargar</button>
</div>

<table class="table">
    <thead>
        <tr>
            <th>Cliente</th>
            <th>Pago</th>
            <th>Facturas</th>
        </tr>
    </thead>
    <tbody id="winner-payments">
        <!-- Rows will be dynamically populated -->
    </tbody>
</table>

<script>
    // Fetch Sorteos and populate dropdown. Select the latest by default.
    async function fetchSorteos(selectLatest = true) {
        let sorteos = [];
        try {
            const response = await fetch('/api/sorteos');
            if (!response.ok) throw new Error('Error cargando sorteos');
            sorteos = await response.json();
        } catch (err) {
            console.error('fetchSorteos error', err);
            const dropdown = document.getElementById('sorteo');
            dropdown.innerHTML = '';
            const opt = document.createElement('option');
            opt.textContent = 'Error cargando sorteos';
            dropdown.appendChild(opt);
            return null;
        }
        const dropdown = document.getElementById('sorteo');
        dropdown.innerHTML = '';

        if (!Array.isArray(sorteos) || sorteos.length === 0) {
            const opt = document.createElement('option');
            opt.textContent = 'No hay sorteos disponibles';
            dropdown.appendChild(opt);
            return null;
        }

        // Sort by date descending just in case server order differs
        sorteos.sort((a,b) => new Date(b.date) - new Date(a.date));

        sorteos.forEach((sorteo, idx) => {
            const option = document.createElement('option');
            option.value = sorteo.id;
            option.textContent = sorteo.date;
            dropdown.appendChild(option);
        });

        // If requested, select the latest (first after sorting) and fetch payments
        if (selectLatest) {
            dropdown.selectedIndex = 0;
            const latestId = dropdown.value;
            if (latestId) fetchWinnerPayments(latestId);
            return latestId;
        }

        return null;
    }

    // Fetch winner payments for the given Sorteo id
    async function fetchWinnerPayments(sorteoId) {
        const id = sorteoId || document.getElementById('sorteo').value;
        const tbody = document.getElementById('winner-payments');
        if (!id) {
            tbody.innerHTML = '<tr><td colspan="3">Seleccione un sorteo primero.</td></tr>';
            return;
        }

        const btn = document.getElementById('refresh-btn');
        btn.disabled = true;
        btn.textContent = 'Cargando...';
        tbody.innerHTML = '';

        let payments = [];
        try {
            const response = await fetch(`/api/winner-payments?sorteo_id=${encodeURIComponent(id)}`);
            if (!response.ok) {
                const text = await response.text();
                throw new Error(`API error: ${response.status} ${text}`);
            }
            payments = await response.json();
        } catch (err) {
            console.error('fetchWinnerPayments error', err);
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 3;
            td.textContent = 'Error cargando pagos. Revisa la consola o intenta de nuevo.';
            tr.appendChild(td);
            tbody.appendChild(tr);
            btn.disabled = false;
            btn.textContent = 'Cargar';
            return;
        }

        if (!Array.isArray(payments) || payments.length === 0) {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 3;
            td.textContent = 'No hay pagos para este sorteo.';
            tr.appendChild(td);
            tbody.appendChild(tr);
            return;
        }

        payments.forEach(payment => {
            const row = document.createElement('tr');

            // Cliente column
            const clienteCell = document.createElement('td');
            clienteCell.textContent = payment.cliente || '';
            row.appendChild(clienteCell);

            // Pago column
            const pagoCell = document.createElement('td');
            pagoCell.textContent = payment.pago || '';
            row.appendChild(pagoCell);

            // Facturas column
            const facturasCell = document.createElement('td');
            if (Array.isArray(payment.facturas) && payment.facturas.length > 0) {
                payment.facturas.forEach(factura => {
                    const a = document.createElement('a');
                    a.href = `/sales/${factura.id}`;
                    a.className = 'btn btn-sm';
                    a.textContent = `Factura ${factura.id}`;
                    facturasCell.appendChild(a);
                    facturasCell.appendChild(document.createTextNode(' '));
                });
            }
            row.appendChild(facturasCell);

            tbody.appendChild(row);
        });
    }

    // Initialize page: populate sorteos and auto-select the latest
    document.addEventListener('DOMContentLoaded', async () => {
        await fetchSorteos(true);
        document.getElementById('refresh-btn').addEventListener('click', () => fetchWinnerPayments());
        // Also allow selecting another sorteo to auto-load when changed
        document.getElementById('sorteo').addEventListener('change', (e) => fetchWinnerPayments(e.target.value));
    });
</script>

{% endblock %}